<project name="bamboo" basedir="." default="test-projects" xmlns:artifact="urn:maven-artifact-ant">

    <import file="build.xml"/>
    <property name="distribution.dir" value="target/${ant.project.name}"/>
        
    <artifact:dependencies pathId="tasks.classpath">
        <dependency groupId="ant-contrib" artifactId="ant-contrib" version="20020829"/>
    </artifact:dependencies>

    <taskdef resource="net/sf/antcontrib/antcontrib.properties" classpathref="tasks.classpath"/>
    
    <target name="clean" description="Deletes distribution directory">
        <delete dir="${distribution.dir}"/>
    </target>

    <target name="create-distros" description="Create the distributions">
        <mkdir dir="${distribution.dir}"/>
        <parallel>
            <createproject web="spring" persistence="hibernate"/>
            <createproject web="spring" persistence="ibatis"/>
            <createproject web="spring" persistence="jdo"/>
            <createproject web="spring" persistence="ojb"/>
            <createproject web="spring" persistence="spring-jdbc"/>
    
            <createproject web="spring-ajax" persistence="hibernate"/>
            <createproject web="spring-ajax" persistence="ibatis"/>
            <createproject web="spring-ajax" persistence="jdo"/>
            <createproject web="spring-ajax" persistence="ojb"/>
            <createproject web="spring-ajax" persistence="spring-jdbc"/>
            
            <createproject web="spring-freemarker" persistence="hibernate"/>
            <createproject web="spring-freemarker" persistence="ibatis"/>
            <createproject web="spring-freemarker" persistence="jdo"/>
            <createproject web="spring-freemarker" persistence="ojb"/>
            <createproject web="spring-freemarker" persistence="spring-jdbc"/>
            
            <createproject web="security" persistence="hibernate"/>
            <createproject web="security" persistence="ibatis"/>
            <createproject web="security" persistence="jdo"/>
            <createproject web="security" persistence="ojb"/>
            <createproject web="security" persistence="spring-jdbc"/>
    
            <createproject web="spring-velocity" persistence="hibernate"/>
            <createproject web="spring-velocity" persistence="ibatis"/>
            <createproject web="spring-velocity" persistence="jdo"/>
            <createproject web="spring-velocity" persistence="ojb"/>
            <createproject web="spring-velocity" persistence="spring-jdbc"/>
    
            <createproject web="jsf" persistence="hibernate"/>
            <createproject web="jsf" persistence="ibatis"/>
            <createproject web="jsf" persistence="jdo"/>
            <createproject web="jsf" persistence="ojb"/>
            <createproject web="jsf" persistence="spring-jdbc"/>
    
            <createproject web="stripes" persistence="hibernate"/>
            <createproject web="stripes" persistence="ibatis"/>
            <createproject web="stripes" persistence="jdo"/>
            <createproject web="stripes" persistence="ojb"/>
            <createproject web="stripes" persistence="spring-jdbc"/>
            
            <createproject web="struts" persistence="hibernate"/>
            <createproject web="struts" persistence="ibatis"/>
            <createproject web="struts" persistence="jdo"/>
            <createproject web="struts" persistence="ojb"/>
            <createproject web="struts" persistence="spring-jdbc"/>
            
            <createproject web="struts2" persistence="hibernate"/>
            <createproject web="struts2" persistence="ibatis"/>
            <createproject web="struts2" persistence="jdo"/>
            <createproject web="struts2" persistence="ojb"/>
            <createproject web="struts2" persistence="spring-jdbc"/>
    
            <createproject web="tapestry" persistence="hibernate"/>
            <createproject web="tapestry" persistence="ibatis"/>
            <createproject web="tapestry" persistence="jdo"/>
            <createproject web="tapestry" persistence="ojb"/>
            <createproject web="tapestry" persistence="spring-jdbc"/>
    
            <createproject web="webwork" persistence="hibernate"/>
            <createproject web="webwork" persistence="ibatis"/>
            <createproject web="webwork" persistence="jdo"/>
            <createproject web="webwork" persistence="ojb"/>
            <createproject web="webwork" persistence="spring-jdbc"/>
            
            <createproject web="wicket" persistence="hibernate"/>
            <createproject web="wicket" persistence="ibatis"/>
            <createproject web="wicket" persistence="jdo"/>
            <createproject web="wicket" persistence="ojb"/>
            <createproject web="wicket" persistence="spring-jdbc"/>
        </parallel>
    </target>

    <target name="test-projects" depends="create-distros" description="Runs all the tests in the various distributions">
        <foreach param="project" target="test-distro">
            <fileset dir="${distribution.dir}">
                <include name="appfuse-light-*"/>
            </fileset>
        </foreach>
    </target>
    
    <target name="test-distro">
        <!-- For some reason, Cargo hangs when starting appfuse-light-jdo, testing with Maven instead -->
        <!--ant dir="${project}" inheritall="false" target="test-all"/-->
        <maven dir="${project}" arg="integration-test"/>
    </target>
    
    <macrodef name="createproject">
        <attribute name="persistence"/>
        <attribute name="web"/>
        <sequential>
            <property name="release.dir" value="${distribution.dir}/appfuse-light-@{web}-@{persistence}"/>
            <mkdir dir="${distribution.dir}/appfuse-light-@{web}-@{persistence}"/>
            <copy todir="${distribution.dir}/appfuse-light-@{web}-@{persistence}">
                <fileset dir="${basedir}">
                    <exclude name="www/**"/>
                    <exclude name="release.*"/>
                    <exclude name="bamboo.*"/>
                    <exclude name="test-*"/>
                    <exclude name="target/**"/>
                </fileset>
            </copy>
            
            <!-- Allow overriding of the username and password to database -->
            <property name="jdbc.username" value="root"/>
            <property name="jdbc.password" value=""/>
            
            <replace file="${distribution.dir}/appfuse-light-@{web}-@{persistence}/src/main/resources/jdbc.properties" 
                token="jdbc.username=root" value="jdbc.username=${jdbc.username}"/>
            <replace file="${distribution.dir}/appfuse-light-@{web}-@{persistence}/src/main/resources/jdbc.properties" 
                token="jdbc.password=" value="jdbc.password=${jdbc.password}"/>
            
            <if>
                <equals arg1="@{web}" arg2="spring"/>
                <else>
                    <ant dir="${distribution.dir}/appfuse-light-@{web}-@{persistence}/extras/@{web}" target="install"/>
                </else>
            </if>
            <if>
                <equals arg1="@{persistence}" arg2="hibernate"/>
               <else>
                    <ant dir="${distribution.dir}/appfuse-light-@{web}-@{persistence}/extras/@{persistence}" target="install"/>
                </else>
            </if>
            <delete dir="${distribution.dir}/appfuse-light-@{web}-@{persistence}/extras"/>
        </sequential>
    </macrodef>
    
    <!-- Simple macro to call proper executables for each OS -->
    <macrodef name="maven">
        <attribute name="dir"/>
        <attribute name="arg"/>
        <sequential>
            <exec dir="@{dir}" executable="mvn.bat" os="Windows XP" failonerror="true">
                <arg line="@{arg}"/>
            </exec>
            <exec dir="@{dir}" executable="mvn" os="Mac OS X" failonerror="true">
                <arg line="@{arg}"/>
            </exec>
            <exec dir="@{dir}" executable="mvn" os="Linux" failonerror="true">
                <arg line="@{arg}"/>
            </exec>
        </sequential>
    </macrodef>
</project>
